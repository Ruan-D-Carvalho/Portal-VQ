<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria de Lojas | Portal VQ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Importando Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* * 1. VARIÁVEIS E RESET (CSS MODERNO) */
        :root {
            --primary: #00A4FF;       /* Azul Vibrante (Predominante) */
            --primary-dark: #0089D6;
            
            --accent: #FFFB00;        /* Amarelo Vibrante (Destaque) */
            --accent-dark: #E6E200;   
            
            --black: #000000;
            --white: #FFFFFF;
            
            --secondary: #64748B;
            --success: #10B981;
            --danger: #EF4444;
            
            --bg-body: #F5F7FA;
            --bg-card: var(--white);
            --bg-sidebar: var(--primary); /* Sidebar AZUL */
            
            --text-main: var(--black);
            --text-muted: #666666;
            --text-light: var(--white);
            
            --border: #E2E8F0;
            --radius: 8px;
            --header-height: 64px;
            --nav-width: 260px;
            --nav-width-collapsed: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-size: 14px;
            overflow-x: hidden;
        }

        /* Utilitários */
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .grid { display: grid; }
        .hidden { display: none !important; }
        .w-full { width: 100%; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 700; }
        .text-center { text-align: center; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .text-muted { color: var(--text-muted); }
        
        /* Botões */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        
        /* Botão Secundário agora usa o Amarelo de destaque */
        .btn-secondary { background: var(--accent); color: var(--black); border: 1px solid rgba(0,0,0,0.05); }
        .btn-secondary:hover { background: var(--accent-dark); }

        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background: var(--white); border-color: var(--primary); color: var(--primary); }
        
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #B91C1C; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }

        /* Form Elements */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.25rem; font-weight: 600; color: var(--text-main); }
        .form-control {
            width: 100%; padding: 0.6rem; border: 1px solid var(--border);
            border-radius: var(--radius); font-family: inherit; background: var(--white); color: var(--text-main);
        }
        .form-control:focus { outline: 2px solid var(--primary); border-color: transparent; }
        
        /* Layouts */
        #login-view {
            height: 100vh; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); /* Fundo Azul */
        }
        .login-card {
            background: var(--bg-card); padding: 2.5rem; border-radius: var(--radius); width: 100%; max-width: 400px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); 
            border-top: 4px solid var(--accent); /* Detalhe Amarelo */
        }

        #app-layout { display: flex; min-height: 100vh; }
        
        /* Sidebar Azul */
        .sidebar {
            width: var(--nav-width); background: var(--bg-sidebar); color: var(--white);
            flex-shrink: 0; position: fixed; height: 100%; z-index: 10;
            transition: width 0.3s ease; overflow-y: auto; overflow-x: hidden; border-right: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Estilos Colapsado */
        .sidebar.collapsed { width: var(--nav-width-collapsed); }
        .sidebar.collapsed .sidebar-header span, 
        .sidebar.collapsed .nav-item a span,
        .sidebar.collapsed .nav-group-title { display: none; }
        .sidebar.collapsed .sidebar-header { justify-content: center; padding: 0; }
        .sidebar.collapsed .nav-item a { justify-content: center; padding: 0.75rem; }
        .sidebar.collapsed .nav-item a i { margin-right: 0; font-size: 1.2rem; }

        /* Botão de Toggle da Sidebar */
        .sidebar-toggle-btn {
            position: absolute; right: -12px; top: 24px;
            background: var(--white); color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 50%; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 20; font-size: 12px; transition: transform 0.3s;
        }
        .sidebar.collapsed .sidebar-toggle-btn { transform: rotate(180deg); }

        .sidebar-header {
            height: var(--header-height); display: flex; align-items: center; padding: 0 1.5rem;
            font-size: 1.1rem; font-weight: 800; border-bottom: 1px solid rgba(255,255,255,0.1); 
            color: var(--white); /* Texto Branco no fundo Azul */
            position: relative;
        }
        .nav-links { list-style: none; padding: 1rem 0; }
        .nav-item a {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.5rem;
            color: rgba(255,255,255,0.8); /* Texto claro */
            text-decoration: none; transition: 0.2s; font-weight: 500;
            white-space: nowrap;
        }
        .nav-item a:hover { color: var(--white); background: rgba(255,255,255,0.1); }
        .nav-item a.active { 
            color: var(--primary); 
            background: var(--white); /* Item ativo Branco */
            font-weight: 700;
        }
        .nav-item a.active i { color: var(--primary); }
        .nav-group-title { padding: 1rem 1.5rem 0.5rem; font-size: 0.7rem; text-transform: uppercase; color: rgba(255,255,255,0.5); font-weight: 700; letter-spacing: 0.05em; white-space: nowrap; }

        .main-content { flex: 1; margin-left: var(--nav-width); display: flex; flex-direction: column; transition: margin-left 0.3s ease; }
        .main-content.expanded { margin-left: var(--nav-width-collapsed); }

        .topbar {
            height: var(--header-height); background: var(--bg-card); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; position: sticky; top: 0; z-index: 5;
        }
        .content-area { padding: 2rem; max-width: 1200px; width: 100%; margin: 0 auto; }

        /* Componentes */
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 1.5rem; border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .kpi-value { font-size: 2rem; font-weight: 800; color: var(--text-main); margin: 0.5rem 0; letter-spacing: -0.02em; }
        .kpi-label { color: var(--text-muted); font-size: 0.875rem; font-weight: 600; text-transform: uppercase; }

        .table-container { overflow-x: auto; background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; text-align: left; min-width: 600px; }
        th { background: #f8fafc; padding: 1rem; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; color: var(--text-main); border-bottom: 2px solid var(--border); }
        td { padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-main); font-weight: 500; }
        tr:hover td { background: #f1f5f9; }
        
        .badge { padding: 0.25rem 0.6rem; border-radius: 999px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: var(--accent); color: var(--black); border: 1px solid rgba(0,0,0,0.1); }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-neutral { background: #f1f5f9; color: #475569; }
        .badge-primary { background: #e0f2fe; color: #0369a1; }

        /* Estilos da Avaliação */
        .eval-container { display: flex; gap: 2rem; align-items: flex-start; }
        .eval-sidebar { width: 280px; flex-shrink: 0; background: white; border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; position: sticky; top: 80px; }
        .eval-main { flex: 1; }
        
        .eval-menu-item { padding: 1rem; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; }
        .eval-menu-item:hover { background: #f8fafc; }
        .eval-menu-item.active { background: #f0f9ff; border-left: 4px solid var(--primary); }
        .eval-menu-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 0.25rem; }
        .eval-menu-stats { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
        .mini-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; }
        .mb-grave { background: #ffedd5; color: #c2410c; }
        .mb-media { background: var(--accent); color: black; }
        .mb-leve { background: #e2e8f0; color: #475569; }
        .mb-gravissima { background: #fee2e2; color: #b91c1c; }

        .progress-container { background: white; padding: 1rem 2rem; border-bottom: 1px solid var(--border); position: sticky; top: var(--header-height); z-index: 4; margin: -2rem -2rem 2rem -2rem; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 6px -4px rgba(0,0,0,0.1); }
        .progress-track { flex: 1; height: 10px; background: #e2e8f0; border-radius: 999px; margin: 0 1.5rem; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }

        .question-item { padding: 1.5rem; background: #f8fafc; border-radius: var(--radius); margin-bottom: 1rem; border: 1px solid var(--border); transition: 0.2s; }
        .question-item:hover { border-color: var(--primary); box-shadow: 0 4px 6px -1px rgba(0, 164, 255, 0.1); }
        
        .severity-badge { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .severity-leve { background: #e2e8f0; color: #475569; }
        .severity-media { background: var(--accent); color: var(--black); }
        .severity-grave { background: #ffedd5; color: #c2410c; }
        .severity-gravissima { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }

        .answer-group { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .answer-btn { flex: 1; padding: 0.75rem; border: 1px solid var(--border); background: var(--white); border-radius: var(--radius); cursor: pointer; font-weight: 600; font-size: 0.9rem; text-align: center; transition: all 0.2s; }
        .answer-btn:hover { background: #f1f5f9; border-color: #ccc; }
        .answer-btn.selected[data-value="conforme"] { background: var(--success); color: white; border-color: var(--success); }
        .answer-btn.selected[data-value="inconforme"] { background: var(--danger); color: white; border-color: var(--danger); }
        .answer-btn.selected[data-value="na"] { background: var(--secondary); color: white; border-color: var(--secondary); }

        .cp-box { display: none; background: #fff; border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 4px solid var(--success); }
        .cp-active { display: block; }

        .media-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
        .media-preview-container { display: flex; gap: 0.5rem; margin-top: 0.5rem; overflow-x: auto; }
        .media-thumbnail { width: 60px; height: 60px; border-radius: 4px; object-fit: cover; border: 1px solid var(--border); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(4px); }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content { background: var(--bg-card); padding: 0; border-radius: 12px; width: 100%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); transform: translateY(20px); transition: transform 0.3s; overflow: hidden; margin: 1rem; border: 1px solid var(--border); }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); background: #f8fafc; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.5rem; background: #f8fafc; }

        #report-print-view { display: none; background: white; padding: 20px; color: black; }
        
        @media print {
            body { background: white; font-size: 12pt; }
            #app-layout, #login-view, .modal-overlay, .btn, .no-print { display: none !important; }
            #report-print-view { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
            .card { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11pt; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .severity-badge { border: 1px solid #999; color: #000; background: transparent; padding: 2px 6px; }
            .badge-success { color: green; border: 1px solid green; background: #fff; }
            .badge-danger { color: red; border: 1px solid red; background: #fff; }
        }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 100%; max-width: 300px; box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
            .sidebar.open { transform: translateX(0); }
            .sidebar-toggle-btn { display: none !important; } /* Esconde toggle desktop no mobile */
            .main-content { margin-left: 0 !important; } /* Remove margem desktop no mobile */
            .topbar { padding: 0 1rem; }
            #menu-toggle { display: block !important; }
            .kpi-grid { grid-template-columns: 1fr; }
            .grid { grid-template-columns: 1fr !important; }
            .answer-group { flex-direction: column; }
            .content-area { padding: 1rem; }
            .eval-container { flex-direction: column; }
            .eval-sidebar { width: 100%; position: static; margin-bottom: 1rem; }
            .progress-container { flex-direction: column; gap: 10px; margin-top: -1rem; }
            .progress-track { width: 100%; margin: 0; }
            .table-container { border: none; background: transparent; }
        }
    </style>
</head>
<body>

    <div id="login-view">
        <div class="login-card">
            <div style="text-align: center; margin-bottom: 2rem;">
                <i class="ph ph-check-circle" style="font-size: 3.5rem; color: var(--primary);"></i>
                <h1 style="margin-top: 1rem; font-size: 1.5rem; font-weight: 800;">Portal VQ</h1>
                <p style="color: var(--text-muted);">Auditoria de Lojas</p>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="login-email" class="form-control" placeholder="admin@empresa.com" value="admin@empresa.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" id="login-password" class="form-control" placeholder="******" value="123" required>
                </div>
                <button type="submit" class="btn btn-primary w-full" style="justify-content: center; padding: 0.8rem;">Entrar</button>
            </form>
        </div>
    </div>

    <div id="app-layout" class="hidden">
        <aside class="sidebar" id="main-sidebar">
            <div class="sidebar-header">
                <i class="ph ph-check-circle" style="margin-right: 10px; color: var(--white); font-size: 1.5rem;"></i> 
                <span>Portal VQ</span>
                <div class="sidebar-toggle-btn" onclick="toggleSidebarDesktop()">
                    <i class="ph ph-caret-left"></i>
                </div>
            </div>
            <ul class="nav-links" id="sidebar-nav-links"></ul>
        </aside>

        <main class="main-content" id="main-content">
            <header class="topbar">
                <div class="flex items-center gap-2">
                    <button class="btn btn-outline btn-sm" onclick="toggleSidebar()" style="display: none;" id="menu-toggle"><i class="ph ph-list"></i></button>
                    <h2 id="page-title" style="font-size: 1.1rem; font-weight: 700;">Home</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div style="text-align: right;">
                        <div id="user-name" style="font-weight: 600;">Usuário</div>
                        <div id="user-role" style="font-size: 0.75rem; color: var(--text-muted);">Admin</div>
                    </div>
                    <button onclick="App.logout()" class="btn btn-outline btn-sm" title="Sair"><i class="ph ph-sign-out"></i></button>
                </div>
            </header>
            <div id="content" class="content-area"></div>
        </main>
    </div>

    <div id="modal-container"></div>
    <div id="report-print-view"></div>

    <script>
        // --- CONFIGURAÇÃO SUPABASE ---
        // Preenchido com as credenciais fornecidas
        const SUPABASE_URL = 'https://tsjyqcrqwssepnjipwhw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzanlxY3Jxd3NzZXBuamlwd2h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MjI4ODksImV4cCI6MjA4MzE5ODg4OX0.v9sJm0MqV4rPZ0Vzvz-97yZFdvCKgksiTxN8dGg0x7M';

        // Inicializa Cliente com nome distinto para evitar conflito global
        let supabaseClient = null;
        try {
            // Usa 'supabaseClient' em vez de 'supabase' para evitar conflitos com a biblioteca carregada via CDN
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch(e) { console.error("Erro Supabase:", e); }

        // Helpers de Conversão Snake_Case <-> CamelCase
        // Isso permite que o DB use 'store_id' e o JS use 'storeId' transparentemente
        const toCamel = (s) => s.replace(/_([a-z])/g, (g) => g[1].toUpperCase());
        const toSnake = (s) => s.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
        
        const keysToCamel = (o) => {
            if (Array.isArray(o)) return o.map(keysToCamel);
            if (o !== null && typeof o === 'object') {
                return Object.keys(o).reduce((acc, key) => {
                    const newKey = toCamel(key);
                    acc[newKey] = keysToCamel(o[key]);
                    return acc;
                }, {});
            }
            return o;
        };

        const keysToSnake = (o) => {
            if (Array.isArray(o)) return o.map(keysToSnake);
            if (o !== null && typeof o === 'object') {
                return Object.keys(o).reduce((acc, key) => {
                    const newKey = toSnake(key);
                    acc[newKey] = keysToSnake(o[key]);
                    return acc;
                }, {});
            }
            return o;
        };


        // --- 1. DATA MANAGER (CONECTADO AO SUPABASE) ---
        const DataManager = {
            db: { users: [], managers: [], stores: [], channels: [], indicators: [], questions: [], evaluations: [] },
            
            async init() {
                if (!supabaseClient) return alert("Erro no Supabase client.");

                try {
                    // Busca dados em paralelo para ser rápido
                    const [users, managers, stores, channels, indicators, questions, evaluations] = await Promise.all([
                        supabaseClient.from('users').select('*'),
                        supabaseClient.from('managers').select('*'),
                        supabaseClient.from('stores').select('*'),
                        supabaseClient.from('channels').select('*'),
                        supabaseClient.from('indicators').select('*'),
                        supabaseClient.from('questions').select('*'),
                        supabaseClient.from('evaluations').select('*, details:evaluation_details(*)') // Join automático
                    ]);

                    if (users.error) throw users.error;

                    // Converte snake_case do banco para camelCase do JS e popula o DB local
                    this.db.users = keysToCamel(users.data);
                    this.db.managers = keysToCamel(managers.data);
                    this.db.stores = keysToCamel(stores.data);
                    this.db.channels = keysToCamel(channels.data);
                    this.db.indicators = keysToCamel(indicators.data);
                    this.db.questions = keysToCamel(questions.data);
                    
                    // Tratamento especial para evaluations e details
                    this.db.evaluations = keysToCamel(evaluations.data).map(ev => {
                        // Supabase retorna o join como 'details', garantimos que é array
                        ev.details = ev.details || [];
                        return ev;
                    });

                } catch (e) {
                    console.error("Erro ao sincronizar dados:", e);
                    alert("Erro de conexão com o Supabase. Verifique o console.");
                }
            },
            
            // Helpers (Getters síncronos continuam iguais pois os dados já foram baixados)
            getStore(id) { return this.db.stores.find(s => s.id == id); },
            getChannel(id) { return this.db.channels.find(c => c.id == id); },
            getManager(id) { return this.db.managers ? this.db.managers.find(m => m.id == id) : null; },
            getIndicatorsByChannel(cId) { return this.db.indicators.filter(i => i.channelId == cId); },
            getQuestionsByIndicator(iId) { return this.db.questions.filter(q => q.indicatorId == iId); },
            getQuestion(qId) { return this.db.questions.find(q => q.id == qId); },
            
            getEvaluationsByUser(user) {
                if (user.role === 'admin') return this.db.evaluations;
                const myStoreIds = this.db.stores.filter(s => s.managerId == user.id).map(s => s.id);
                return this.db.evaluations.filter(e => myStoreIds.includes(e.storeId));
            },
            getStoresByUser(user) {
                if (user.role === 'admin') return this.db.stores;
                return this.db.stores.filter(s => s.managerId == user.id);
            },

            // Async Actions
            async addEvaluation(evalObj) {
                // 1. Prepara Objeto Pai (Evaluation)
                const evalPayload = keysToSnake({
                    storeId: evalObj.storeId,
                    channelId: evalObj.channelId,
                    evaluator: evalObj.evaluator,
                    score: evalObj.score,
                    date: evalObj.date,
                    coveringManager: evalObj.coveringManager
                });

                // Insere Pai
                const { data: newEval, error } = await supabaseClient.from('evaluations').insert(evalPayload).select().single();
                if (error) {
                    console.error(error);
                    return alert("Erro ao salvar auditoria: " + error.message);
                }

                // 2. Prepara Detalhes
                const detailsPayload = evalObj.details.map(d => keysToSnake({
                    evaluationId: newEval.id,
                    questionId: d.questionId,
                    answer: d.answer,
                    comment: d.comment,
                    cpValidated: d.cpValidated,
                    media: d.media
                }));

                // Insere Filhos
                const { error: errDetails } = await supabaseClient.from('evaluation_details').insert(detailsPayload);
                if (errDetails) return alert("Erro ao salvar detalhes: " + errDetails.message);

                // Atualiza local e adiciona os detalhes ao objeto retornado
                evalObj.id = newEval.id;
                this.db.evaluations.unshift(evalObj);
                return evalObj;
            },

            async addItem(collection, item) {
                // Converte para formato DB
                const payload = keysToSnake(item);
                delete payload.id; // Deixa o banco gerar ID

                const { data, error } = await supabaseClient.from(collection).insert(payload).select().single();
                
                if(!error && data) {
                    item.id = data.id;
                    this.db[collection].push(item);
                } else { alert("Erro ao salvar: " + (error?.message || 'Unknown')); }
            },

            async updateItem(collection, item) {
                const payload = keysToSnake(item);
                const id = payload.id;
                delete payload.id; // Não atualiza ID no payload

                const { error } = await supabaseClient.from(collection).update(payload).eq('id', id);

                if(!error) {
                    const idx = this.db[collection].findIndex(x => x.id == item.id);
                    if(idx > -1) this.db[collection][idx] = item;
                } else { alert("Erro ao atualizar: " + error.message); }
            },

            async deleteItem(collection, id) {
                const { error } = await supabaseClient.from(collection).delete().eq('id', id);
                if(!error) {
                    this.db[collection] = this.db[collection].filter(x => x.id != id);
                } else { alert("Erro ao excluir: " + error.message); }
            }
        };

        // --- 2. UTILS ---
        const Utils = {
            formatDate(dateStr) { if(!dateStr) return "-"; const [y, m, d] = dateStr.split('-'); return `${d}/${m}/${y}`; },
            getClassByScore(score) { if (score >= 90) return 'success'; if (score >= 70) return 'warning'; return 'danger'; },
            getPenaltyPoints(severity) { const points = { 'gravissima': 50, 'grave': 4, 'media': 2.5, 'leve': 1 }; return points[severity] || 0; },
            getSeverityBadge(severity) { const map = { 'leve': 'Leve (-1)', 'media': 'Média (-2.5)', 'grave': 'Grave (-4)', 'gravissima': 'Gravíssima (-50)' }; return `<span class="severity-badge severity-${severity}">${map[severity] || severity}</span>`; },
            getStatusBadge(status) { const colors = { 'Ativa': 'success', 'Desligada': 'danger', 'Férias': 'warning' }; return `<span class="badge badge-${colors[status] || 'neutral'}">${status}</span>`; }
        };

        // --- 3. APP CORE & AUTH ---
        const App = {
            currentUser: null,
            async init() {
                // Initialize DataManager first
                await DataManager.init();
                
                const loginForm = document.getElementById('login-form');
                if(loginForm) {
                    const newForm = loginForm.cloneNode(true);
                    loginForm.parentNode.replaceChild(newForm, loginForm);
                    newForm.addEventListener('submit', LoginController.login);
                }
                const userStr = localStorage.getItem('vq_user');
                if (userStr) {
                    this.currentUser = JSON.parse(userStr);
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('app-layout').classList.remove('hidden');
                    this.renderSidebar();
                    document.getElementById('user-name').innerText = this.currentUser.name;
                    document.getElementById('user-role').innerText = this.currentUser.role === 'admin' ? 'Administrador' : 'Gestora';
                    this.navigate('home');
                } else { LoginController.render(); }
            },
            logout() { localStorage.removeItem('vq_user'); location.reload(); },
            renderSidebar() {
                const nav = document.getElementById('sidebar-nav-links');
                const isAdmin = this.currentUser.role === 'admin';
                let html = `
                    <li class="nav-item"><a href="#" onclick="App.navigate('home')" id="nav-home"><i class="ph ph-house"></i> <span>Home</span></a></li>
                    <li class="nav-item"><a href="#" onclick="App.navigate('dashboard')" id="nav-dashboard"><i class="ph ph-chart-line-up"></i> <span>Dashboard</span></a></li>
                    <div class="nav-group-title">Auditoria</div>`;
                if (isAdmin) html += `<li class="nav-item"><a href="#" onclick="App.navigate('new-eval')" id="nav-new-eval"><i class="ph ph-plus-circle"></i> <span>Nova Auditoria</span></a></li>`;
                html += `<li class="nav-item"><a href="#" onclick="App.navigate('history')" id="nav-history"><i class="ph ph-list-dashes"></i> <span>Histórico</span></a></li>`;
                if (isAdmin) {
                    html += `
                        <div class="nav-group-title">Configurações</div>
                        <li class="nav-item"><a href="#" onclick="App.navigate('settings-users')" id="nav-settings-users"><i class="ph ph-user-gear"></i> <span>Usuários</span></a></li>
                        <li class="nav-item"><a href="#" onclick="App.navigate('settings-managers')" id="nav-settings-managers"><i class="ph ph-users"></i> <span>Gestoras (RH)</span></a></li>
                        <li class="nav-item"><a href="#" onclick="App.navigate('settings-stores')" id="nav-settings-stores"><i class="ph ph-storefront"></i> <span>Lojas</span></a></li>
                        <li class="nav-item"><a href="#" onclick="App.navigate('settings-channels')" id="nav-settings-channels"><i class="ph ph-tree-structure"></i> <span>Canais</span></a></li>
                        <li class="nav-item"><a href="#" onclick="App.navigate('settings-indicators')" id="nav-settings-indicators"><i class="ph ph-list-checks"></i> <span>Indicadores</span></a></li>
                        <li class="nav-item"><a href="#" onclick="App.navigate('settings-questions')" id="nav-settings-questions"><i class="ph ph-question"></i> <span>Perguntas</span></a></li>
                    `;
                }
                nav.innerHTML = html;
            },
            navigate(route) {
                const content = document.getElementById('content');
                const titleEl = document.getElementById('page-title');
                const isAdmin = this.currentUser && this.currentUser.role === 'admin';
                const titles = { 'home':'Visão Geral', 'dashboard':'Dashboard', 'new-eval':'Nova Auditoria', 'history':'Histórico', 'settings-users':'Usuários', 'settings-managers':'Gestoras', 'settings-stores':'Lojas', 'settings-channels':'Canais', 'settings-indicators':'Indicadores', 'settings-questions':'Perguntas' };
                titleEl.innerText = titles[route] || 'Sistema';
                document.querySelectorAll('.nav-item a').forEach(el => el.classList.remove('active'));
                const activeLink = document.getElementById(`nav-${route}`);
                if(activeLink) activeLink.classList.add('active');

                if (!isAdmin && route.startsWith('settings-')) { alert("Acesso negado."); return this.navigate('home'); }

                switch(route) {
                    case 'home': content.innerHTML = HomeController.render(); break;
                    case 'dashboard': content.innerHTML = DashboardController.render(); break;
                    case 'new-eval': content.innerHTML = NewEvaluationController.render(); break;
                    case 'history': content.innerHTML = HistoryController.render(); break;
                    case 'settings-users': if(isAdmin) content.innerHTML = SettingsUserController.render(); break;
                    case 'settings-managers': if(isAdmin) content.innerHTML = SettingsManagerController.render(); break;
                    case 'settings-stores': if(isAdmin) content.innerHTML = SettingsStoreController.render(); break;
                    case 'settings-channels': if(isAdmin) content.innerHTML = SettingsChannelController.render(); break;
                    case 'settings-indicators': if(isAdmin) content.innerHTML = SettingsIndicatorController.render(); break;
                    case 'settings-questions': if(isAdmin) content.innerHTML = SettingsQuestionController.render(); break;
                }
                if (window.innerWidth <= 768) document.querySelector('.sidebar').classList.remove('open');
            }
        };

        const LoginController = {
            render() { document.getElementById('login-view').classList.remove('hidden'); document.getElementById('app-layout').classList.add('hidden'); },
            async login(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value.toLowerCase(); // Ensure lowercase match
                const password = document.getElementById('login-password').value;

                if (!supabaseClient) return alert("Configure o Supabase primeiro!");

                // Busca usuário na tabela 'users' (Simulação de Auth para compatibilidade)
                const { data, error } = await supabaseClient.from('users').select('*').eq('email', email).single();

                if (data && data.password === password) {
                    const user = keysToCamel(data);
                    delete user.password;
                    localStorage.setItem('vq_user', JSON.stringify(user));
                    location.reload(); 
                } else {
                    alert("Credenciais inválidas ou erro de conexão.");
                }
            }
        };

        // --- 4. VIEW CONTROLLERS ---

        const HomeController = {
            render() {
                const user = App.currentUser;
                const evals = DataManager.getEvaluationsByUser(user);
                const stores = DataManager.getStoresByUser(user);
                let actionsHtml = user.role === 'admin' 
                    ? `<button class="btn btn-primary btn-sm w-full" onclick="App.navigate('new-eval')">Nova Auditoria</button><button class="btn btn-secondary btn-sm w-full" onclick="App.navigate('settings-managers')">Gerenciar Equipe</button>` 
                    : `<button class="btn btn-outline btn-sm w-full" onclick="App.navigate('history')">Ver Meus Resultados</button>`;
                return `
                    <div class="kpi-grid">
                        <div class="card"><span class="kpi-label">Auditorias</span><div class="kpi-value">${evals.length}</div></div>
                        <div class="card"><span class="kpi-label">Lojas</span><div class="kpi-value">${stores.length}</div></div>
                        <div class="card"><span class="kpi-label">Ações</span><div class="flex gap-2 mt-2">${actionsHtml}</div></div>
                    </div>`;
            }
        };

        const DashboardController = {
            render() {
                const user = App.currentUser;
                const evals = DataManager.getEvaluationsByUser(user);
                let avgScore = 0, aboveTarget = 0, critical = 0;
                if (evals.length > 0) {
                    const totalScore = evals.reduce((sum, e) => sum + e.score, 0);
                    avgScore = Math.round(totalScore / evals.length);
                    aboveTarget = evals.filter(e => e.score >= 80).length;
                    critical = evals.filter(e => e.score < 60).length;
                }
                return `
                    <div class="card mb-4"><div class="flex gap-4 items-end flex-wrap"><div class="form-group mb-0" style="flex:1;"><label class="form-label">Período</label><select class="form-control"><option>Todos</option></select></div><button class="btn btn-primary">Filtrar</button></div></div>
                    <div class="kpi-grid">
                        <div class="card" style="border-left: 4px solid var(--primary);"><span class="kpi-label">Média ${user.role === 'admin'?'Geral':'Minhas Lojas'}</span><div class="kpi-value">${avgScore}%</div></div>
                        <div class="card" style="border-left: 4px solid var(--success);"><span class="kpi-label">Na Meta (>80%)</span><div class="kpi-value">${aboveTarget}</div></div>
                        <div class="card" style="border-left: 4px solid var(--danger);"><span class="kpi-label">Críticas (<60%)</span><div class="kpi-value">${critical}</div></div>
                    </div>
                    <div class="card"><h3 class="font-bold mb-4">Evolução</h3><div style="display:flex; align-items:flex-end; gap:10px; height:150px; padding-top:20px; border-bottom:1px solid #e2e8f0;">${evals.slice(0, 10).reverse().map(e => `<div title="${Utils.formatDate(e.date)}: ${e.score}%" style="flex:1; height:${e.score}%; background:var(--primary); opacity:0.8;"></div>`).join('')}</div></div>`;
            }
        };

        const HistoryController = {
            render() {
                const user = App.currentUser;
                const evals = DataManager.getEvaluationsByUser(user);
                const isAdmin = user.role === 'admin';
                return `
                    <div class="card"><div class="flex justify-between items-center mb-4"><h3 class="font-bold">Histórico</h3></div>
                    <div class="table-container"><table><thead><tr><th>Data</th><th>Loja</th><th>Canal</th><th>Nota</th><th class="text-right">Ações</th></tr></thead><tbody>
                        ${evals.map(ev => {
                            const store = DataManager.getStore(ev.storeId);
                            const channel = DataManager.getChannel(ev.channelId);
                            const badgeClass = Utils.getClassByScore(ev.score);
                            const deleteBtn = isAdmin ? `<button class="btn btn-danger btn-sm" onclick="DataManager.deleteItem('evaluations', ${ev.id}); setTimeout(()=>App.navigate('history'), 200);"><i class="ph ph-trash"></i></button>` : '';
                            return `<tr><td>${Utils.formatDate(ev.date)}</td><td class="font-bold">${store ? store.name : 'Removida'}</td><td>${channel ? channel.name : '-'}</td><td><span class="badge badge-${badgeClass}">${ev.score}%</span></td><td class="text-right"><button class="btn btn-outline btn-sm" onclick="ReportController.generateAndPrint(DataManager.db.evaluations.find(e => e.id == ${ev.id}))"><i class="ph ph-printer"></i></button>${deleteBtn}</td></tr>`;
                        }).join('')}
                    </tbody></table></div></div>`;
            }
        };

        const ReportController = {
            generateAndPrint(evaluation) {
                const store = DataManager.getStore(evaluation.storeId);
                const channel = DataManager.getChannel(evaluation.channelId);
                let managerName = '-';
                if (store && store.managerId) { const m = DataManager.getManager(store.managerId); managerName = m ? m.name : 'N/A'; } 
                else if (store && store.manager) { managerName = store.manager; }
                if (evaluation.coveringManager) managerName += ` (Cobertura: ${evaluation.coveringManager})`;
                
                let deductions = 0, cpCount = 0;
                evaluation.details.forEach(det => {
                    const q = DataManager.getQuestion(det.questionId);
                    if (q && det.answer === 'inconforme') {
                        if (det.cpValidated) cpCount++;
                        else deductions += Utils.getPenaltyPoints(q.severity);
                    }
                });

                const reportHtml = `
                    <div style="max-width: 800px; margin: 0 auto; font-family: sans-serif;">
                        <div style="display:flex; justify-content:space-between; border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:20px;"><h1>Relatório de Auditoria</h1><div style="text-align:right;"><div>Data: ${Utils.formatDate(evaluation.date)}</div><div>ID: #${evaluation.id}</div></div></div>
                        <div style="margin-bottom:20px; border:1px solid #ddd; padding:15px; border-radius:4px;"><div style="display:grid; grid-template-columns:1fr 1fr;"><div><strong>Loja:</strong> ${store ? store.name : 'N/A'}</div><div><strong>Canal:</strong> ${channel ? channel.name : 'N/A'}</div><div><strong>Gestora:</strong> ${managerName}</div></div></div>
                        <div style="display:flex; gap:20px; margin-bottom:30px;"><div style="flex:1; border:1px solid #ddd; padding:10px;"><h3>Pontuação Final</h3><div style="font-size:32px; font-weight:bold; color:${evaluation.score >= 80 ? 'green' : 'red'}; text-align:center;">${evaluation.score} pts</div><div style="text-align:center; font-size:0.8rem; color:#666;">(Inicial: 100 - Deduções: ${deductions})</div></div><div style="flex:1; border:1px solid #ddd; padding:10px;"><h3>Correções (CP)</h3><div>CPs Validados: <strong>${cpCount}</strong></div><div style="font-size:0.8rem; color:#666;">*CPs evitam perda de pontos em Média/Leve</div></div></div>
                        <h3>Detalhamento</h3>
                        <table><thead><tr><th>Questão</th><th>Gravidade</th><th>Situação</th><th>Obs</th></tr></thead><tbody>
                            ${evaluation.details.map(det => {
                                const q = DataManager.getQuestion(det.questionId);
                                if (!q) return '';
                                let rowStyle = '', statusText = 'Conforme';
                                if (det.answer === 'inconforme') {
                                    if (det.cpValidated) { statusText = 'Inconforme (CP Validado)'; rowStyle = 'color: #d97706;'; } 
                                    else { statusText = `Inconforme (-${Utils.getPenaltyPoints(q.severity)})`; rowStyle = 'color: red; font-weight:bold;'; }
                                } else if (det.answer === 'na') { statusText = 'N/A'; rowStyle = 'color: #999;'; }
                                return `<tr style="${rowStyle}"><td>${q.text}</td><td>${Utils.getSeverityBadge(q.severity)}</td><td>${statusText}</td><td>${det.comment || ''}</td></tr>`;
                            }).join('')}
                        </tbody></table>
                    </div>`;
                const printContainer = document.getElementById('report-print-view');
                printContainer.innerHTML = reportHtml;
                setTimeout(() => { window.print(); }, 500);
            }
        };

        const NewEvaluationController = {
            state: { active: false, selectedStore: null, selectedChannel: null, selectedDate: null, activeIndicatorId: null, answers: {}, coveringManager: null },
            
            render() {
                if (this.state.active && this.state.selectedStore) return this.renderChecklistLayout();
                setTimeout(() => this.openSetupModal(), 100);
                return `<div class="card flex items-center justify-center" style="height: 400px; border: 2px dashed var(--border);"><p class="text-center text-muted">Carregando...</p></div>`;
            },

            openSetupModal() {
                const stores = DataManager.db.stores;
                const availableManagers = DataManager.db.managers ? DataManager.db.managers.filter(m => m.status !== 'Desligada') : [];
                const modalHtml = `
                    <div class="modal-overlay active" id="eval-setup-modal">
                        <div class="modal-content"><div class="modal-header"><h3>Nova Auditoria</h3><button onclick="NewEvaluationController.closeSetupModal()"><i class="ph ph-x"></i></button></div>
                            <div class="modal-body">
                                <div class="form-group"><label class="form-label">Loja</label><select id="setup-store" class="form-control" onchange="NewEvaluationController.onModalStoreChange(this)"><option value="">Selecione...</option>${stores.map(s => `<option value="${s.id}">${s.code} - ${s.name}</option>`).join('')}</select></div>
                                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;"><div class="form-group"><label class="form-label">Gestora</label><input type="text" id="setup-manager-preview" class="form-control" disabled placeholder="-"></div><div class="form-group"><label class="form-label">Status</label><div id="setup-manager-status">-</div></div></div>
                                <div id="covering-manager-group" class="form-group hidden" style="background:#fff9c4; padding:10px; border-radius:8px; border:1px solid #fde047;"><label class="form-label" style="color:#854d0e;">Gestora de Cobertura</label><select id="setup-covering-manager" class="form-control"><option value="">Selecione...</option>${availableManagers.map(m => `<option value="${m.name}">${m.name}</option>`).join('')}</select></div>
                                <div class="form-group"><label class="form-label">Data</label><input type="date" id="setup-date" class="form-control" value="${new Date().toISOString().split('T')[0]}"></div>
                            </div>
                            <div class="modal-footer"><button class="btn btn-primary" onclick="NewEvaluationController.confirmSetup()">Iniciar</button></div>
                        </div></div>`;
                document.getElementById('modal-container').innerHTML = modalHtml;
            },

            onModalStoreChange(el) {
                const storeId = el.value;
                const coveringGroup = document.getElementById('covering-manager-group');
                const coveringSelect = document.getElementById('setup-covering-manager');
                if(storeId) {
                    const store = DataManager.getStore(storeId);
                    if(store && store.managerId) {
                        const manager = DataManager.getManager(store.managerId);
                        document.getElementById('setup-manager-preview').value = manager ? manager.name : 'N/A';
                        document.getElementById('setup-manager-status').innerHTML = manager ? Utils.getStatusBadge(manager.status) : '-';
                        if (manager && manager.status === 'Férias') { coveringGroup.classList.remove('hidden'); coveringSelect.required = true; } 
                        else { coveringGroup.classList.add('hidden'); coveringSelect.required = false; }
                    } else { coveringGroup.classList.add('hidden'); }
                } else { coveringGroup.classList.add('hidden'); }
            },

            closeSetupModal() { document.getElementById('modal-container').innerHTML = ''; if (!this.state.active) App.navigate('home'); },

            confirmSetup() {
                const storeId = document.getElementById('setup-store').value;
                const date = document.getElementById('setup-date').value;
                const coveringManager = document.getElementById('setup-covering-manager').value;
                const isCoveringVisible = !document.getElementById('covering-manager-group').classList.contains('hidden');
                
                if (isCoveringVisible && !coveringManager) return alert("Selecione a gestora que está cobrindo.");
                if (!storeId || !date) return alert("Preencha os campos.");
                
                const store = DataManager.getStore(storeId);
                const indicators = DataManager.getIndicatorsByChannel(store.channelId);
                
                if(indicators.length === 0) return alert("Nenhum indicador configurado para este canal.");

                this.state.active = true;
                this.state.selectedStore = store;
                this.state.selectedChannel = store.channelId;
                this.state.selectedDate = date;
                this.state.coveringManager = isCoveringVisible ? coveringManager : null; 
                this.state.answers = {};
                this.state.activeIndicatorId = indicators[0].id;
                
                this.closeSetupModal();
                document.getElementById('content').innerHTML = this.renderChecklistLayout();
                this.updateUI();
            },

            renderChecklistLayout() {
                const store = this.state.selectedStore;
                const indicators = DataManager.getIndicatorsByChannel(this.state.selectedChannel);
                
                let managerName = '-';
                if (store.managerId) {
                    const m = DataManager.getManager(store.managerId);
                    managerName = m ? m.name : 'N/A';
                } else if (store.manager) { managerName = store.manager; }
                if (this.state.coveringManager) managerName += ` (Cob.: ${this.state.coveringManager})`;

                return `
                    <div style="position: fixed; bottom: 30px; left: 20px; z-index: 49; background: var(--black); color: var(--accent); padding: 12px 20px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; border: 1px solid var(--accent);">
                        <i class="ph ph-storefront" style="font-size: 1.1rem;"></i>
                        <span>${store.name}</span>
                        <span style="opacity: 0.5;">|</span>
                        <i class="ph ph-user" style="font-size: 1.1rem;"></i>
                        <span>${managerName}</span>
                    </div>

                    <div class="progress-container">
                        <div class="font-bold text-sm">Progresso Global: <span id="progress-text">0%</span></div>
                        <div class="progress-track"><div id="progress-bar" class="progress-fill"></div></div>
                        <button class="btn btn-outline btn-sm" onclick="App.navigate('home')">Cancelar</button>
                    </div>

                    <div class="eval-container">
                        <div class="eval-sidebar" id="indicator-menu">${this.renderIndicatorMenu(indicators)}</div>
                        <div class="eval-main">
                            <div class="card mb-4" style="background:#f8fafc; border-bottom: 2px solid var(--primary);"><h3 class="text-lg font-bold" id="active-indicator-title">...</h3></div>
                            <div id="questions-container"></div>
                            <div class="mt-4 text-right"><button id="btn-save-audit" class="btn btn-primary" onclick="NewEvaluationController.submit()" disabled><i class="ph ph-check"></i> Salvar Auditoria (100% Necessário)</button></div>
                        </div>
                    </div>`;
            },

            renderIndicatorMenu(indicators) {
                return indicators.map(ind => `
                    <div class="eval-menu-item ${ind.id == this.state.activeIndicatorId ? 'active' : ''}" id="menu-ind-${ind.id}" onclick="NewEvaluationController.switchIndicator(${ind.id})">
                        <div class="eval-menu-title">${ind.name}</div><div class="eval-menu-stats" id="stats-ind-${ind.id}"></div>
                    </div>`).join('');
            },

            switchIndicator(indId) {
                this.state.activeIndicatorId = indId;
                document.querySelectorAll('.eval-menu-item').forEach(el => el.classList.remove('active'));
                document.getElementById(`menu-ind-${indId}`).classList.add('active');
                this.renderActiveQuestions();
            },

            renderActiveQuestions() {
                const ind = DataManager.db.indicators.find(i => i.id == this.state.activeIndicatorId);
                document.getElementById('active-indicator-title').innerText = ind.name;
                const questions = DataManager.getQuestionsByIndicator(ind.id);
                const container = document.getElementById('questions-container');
                if (questions.length === 0) container.innerHTML = '<div class="p-4 text-center text-muted">Nenhuma pergunta neste indicador.</div>';
                else container.innerHTML = questions.map(q => this.renderQuestionRow(q)).join('');
            },

            renderQuestionRow(q) {
                const ans = this.state.answers[q.id] || { media: [] };
                let previewsHtml = ans.media && ans.media.length > 0 ? '<div class="media-preview-container">' + ans.media.map(m => `<img src="${m.type === 'image' ? m.url : ''}" class="media-thumbnail">`).join('') + '</div>' : '';
                const showCp = ans.value === 'inconforme' && (q.severity === 'media' || q.severity === 'leve');
                const cpChecked = ans.cpValidated ? 'checked' : '';

                return `
                    <div class="question-item" id="q-row-${q.id}">
                        <div class="flex justify-between items-start mb-3"><div class="font-medium text-main">${q.text}</div>${Utils.getSeverityBadge(q.severity)}</div>
                        <div class="answer-group">
                            <div class="answer-btn ${ans.value === 'conforme' ? 'selected' : ''}" onclick="NewEvaluationController.selectAnswer(${q.id}, 'conforme')" data-value="conforme"><i class="ph ph-thumbs-up"></i> Conforme</div>
                            <div class="answer-btn ${ans.value === 'inconforme' ? 'selected' : ''}" onclick="NewEvaluationController.selectAnswer(${q.id}, 'inconforme')" data-value="inconforme"><i class="ph ph-thumbs-down"></i> Inconforme</div>
                            <div class="answer-btn ${ans.value === 'na' ? 'selected' : ''}" onclick="NewEvaluationController.selectAnswer(${q.id}, 'na')" data-value="na"><i class="ph ph-prohibit"></i> N/A</div>
                        </div>
                        <div id="cp-container-${q.id}" class="cp-box ${showCp ? 'cp-active' : ''}">
                            <label class="flex items-center gap-2 cursor-pointer font-bold"><input type="checkbox" onchange="NewEvaluationController.toggleCp(${q.id}, this.checked)" ${cpChecked}> Possui Plano de Correção (CP) Validado?</label>
                            <div class="text-xs text-muted mt-1">Se marcado, não haverá dedução de pontos.</div>
                        </div>
                        <div><textarea class="form-control mb-2 mt-2" placeholder="Comentário..." rows="2" onchange="NewEvaluationController.updateComment(${q.id}, this.value)">${ans.comment || ''}</textarea>
                        <div class="media-actions"><input type="file" id="input-img-${q.id}" accept="image/*" style="display:none" onchange="NewEvaluationController.handleMedia(this, 'image', ${q.id})"><button class="btn btn-secondary btn-sm" onclick="document.getElementById('input-img-${q.id}').click()"><i class="ph ph-camera"></i> Foto</button></div>${previewsHtml}</div>
                    </div>`;
            },

            selectAnswer(qId, val) {
                if(!this.state.answers[qId]) this.state.answers[qId] = { media: [] };
                this.state.answers[qId].value = val;
                document.getElementById(`q-row-${qId}`).outerHTML = this.renderQuestionRow(DataManager.getQuestion(qId));
                this.updateUI();
            },

            toggleCp(qId, isChecked) {
                if(!this.state.answers[qId]) this.state.answers[qId] = { media: [] };
                this.state.answers[qId].cpValidated = isChecked;
                this.updateUI();
            },

            updateComment(qId, val) { if(!this.state.answers[qId]) this.state.answers[qId] = { media: [] }; this.state.answers[qId].comment = val; },

            handleMedia(input, type, qId) {
                if (input.files && input.files[0]) {
                    const file = input.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if(!this.state.answers[qId]) this.state.answers[qId] = { media: [] };
                        if(!this.state.answers[qId].media) this.state.answers[qId].media = [];
                        this.state.answers[qId].media.push({ type: type, url: e.target.result, name: file.name });
                        document.getElementById(`q-row-${qId}`).outerHTML = this.renderQuestionRow(DataManager.getQuestion(qId));
                    };
                    reader.readAsDataURL(file);
                }
            },

            updateUI() {
                const indicators = DataManager.getIndicatorsByChannel(this.state.selectedChannel);
                let totalQ = 0, answeredQ = 0;
                indicators.forEach(ind => {
                    const questions = DataManager.getQuestionsByIndicator(ind.id);
                    totalQ += questions.length;
                    let counts = { grave: 0, media: 0, leve: 0, gravissima: 0 };
                    questions.forEach(q => {
                        const ans = this.state.answers[q.id];
                        if (ans && ans.value) {
                            answeredQ++;
                            if (ans.value === 'inconforme') counts[q.severity]++;
                        }
                    });
                    const statsDiv = document.getElementById(`stats-ind-${ind.id}`);
                    if (statsDiv) {
                        let html = '';
                        if (counts.gravissima > 0) html += `<span class="mini-badge mb-gravissima">${counts.gravissima} GG</span>`;
                        if (counts.grave > 0) html += `<span class="mini-badge mb-grave">${counts.grave} G</span>`;
                        if (counts.media > 0) html += `<span class="mini-badge mb-media">${counts.media} M</span>`;
                        if (counts.leve > 0) html += `<span class="mini-badge mb-leve">${counts.leve} L</span>`;
                        const indTotal = questions.length;
                        const indAnswered = questions.filter(q => this.state.answers[q.id]?.value).length;
                        if (indTotal > 0 && indTotal === indAnswered) html += `<i class="ph ph-check-circle" style="color:var(--success); margin-left:auto;"></i>`;
                        statsDiv.innerHTML = html;
                    }
                });
                const pct = totalQ > 0 ? Math.round((answeredQ / totalQ) * 100) : 0;
                document.getElementById('progress-bar').style.width = `${pct}%`;
                document.getElementById('progress-text').innerText = `${pct}%`;
                const btnSave = document.getElementById('btn-save-audit');
                if (btnSave) btnSave.disabled = pct < 100;
            },

            async submit() {
                const indicators = DataManager.getIndicatorsByChannel(this.state.selectedChannel);
                let details = [], currentScore = 100;
                let allQuestions = [];
                indicators.forEach(ind => allQuestions.push(...DataManager.getQuestionsByIndicator(ind.id)));

                for (let q of allQuestions) {
                    const ans = this.state.answers[q.id];
                    if (!ans || !ans.value) return alert("Erro: Perguntas pendentes.");
                    details.push({ questionId: q.id, answer: ans.value, comment: ans.comment || "", media: ans.media || [], cpValidated: ans.cpValidated });
                    if (ans.value === 'inconforme') {
                        if (!((q.severity === 'media' || q.severity === 'leve') && ans.cpValidated)) currentScore -= Utils.getPenaltyPoints(q.severity);
                    }
                }

                if (currentScore < 0) currentScore = 0;
                
                // Enviar para API via DataManager
                const evalObj = await DataManager.addEvaluation({
                    storeId: this.state.selectedStore.id, channelId: this.state.selectedChannel,
                    date: this.state.selectedDate, evaluator: App.currentUser.name, score: currentScore, 
                    details: details, coveringManager: this.state.coveringManager
                });
                
                if (evalObj) {
                    alert(`Auditoria Salva! Nota Final: ${currentScore} pontos.`);
                    this.state.active = false;
                    ReportController.generateAndPrint(evalObj);
                }
            }
        };

        const SettingsUserController = {
            render() {
                const users = DataManager.db.users || [];
                return `<div class="card"><div class="flex justify-between items-center mb-4"><h3 class="font-bold">Usuários e Permissões</h3><button class="btn btn-primary btn-sm" onclick="SettingsUserController.openModal()"><i class="ph ph-plus"></i> Novo Usuário</button></div><div class="table-container"><table><thead><tr><th>Nome</th><th>Email (Login)</th><th>Função</th><th class="text-right">Ações</th></tr></thead><tbody>${users.map(u => `<tr><td class="font-bold">${u.name}</td><td>${u.email}</td><td><span class="badge ${u.role === 'admin' ? 'badge-primary' : 'badge-warning'}">${u.role === 'admin' ? 'Administrador' : 'Gestora'}</span></td><td class="text-right"><button class="btn btn-outline btn-sm" onclick="SettingsUserController.openModal(${u.id})"><i class="ph ph-pencil-simple"></i></button><button class="btn btn-danger btn-sm" onclick="if(confirm('Excluir usuário?')) { DataManager.deleteItem('users', ${u.id}); setTimeout(()=>App.navigate('settings-users'),200); }"><i class="ph ph-trash"></i></button></td></tr>`).join('')}</tbody></table></div></div>`;
            },
            openModal(id = null) {
                const user = id ? DataManager.db.users.find(u => u.id == id) : null;
                const isEdit = !!user;
                const html = `<div class="modal-overlay active"><div class="modal-content"><div class="modal-header"><h3>${isEdit ? 'Editar' : 'Novo'} Usuário</h3><button onclick="document.getElementById('modal-container').innerHTML=''"><i class="ph ph-x"></i></button></div><div class="modal-body"><input type="hidden" id="usr-id" value="${isEdit ? user.id : ''}"><div class="form-group"><label class="form-label">Nome Completo</label><input type="text" id="usr-name" class="form-control" value="${isEdit ? user.name : ''}" required></div><div class="form-group"><label class="form-label">Email (Login)</label><input type="email" id="usr-email" class="form-control" value="${isEdit ? user.email : ''}" required></div><div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;"><div class="form-group"><label class="form-label">Função</label><select id="usr-role" class="form-control"><option value="manager" ${isEdit && user.role === 'manager' ? 'selected' : ''}>Gestora</option><option value="admin" ${isEdit && user.role === 'admin' ? 'selected' : ''}>Administrador</option></select></div><div class="form-group"><label class="form-label">Senha</label><input type="text" id="usr-pass" class="form-control" value="${isEdit ? user.password : '123'}"></div></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="SettingsUserController.save()">Salvar</button></div></div></div>`;
                document.getElementById('modal-container').innerHTML = html;
            },
            async save() {
                const id = document.getElementById('usr-id').value;
                const name = document.getElementById('usr-name').value;
                const email = document.getElementById('usr-email').value;
                const role = document.getElementById('usr-role').value;
                const password = document.getElementById('usr-pass').value;
                if (!name || !email || !password) return alert("Preencha todos os campos.");
                const obj = { id: id || undefined, name, email, role, password };
                if(id) await DataManager.updateItem('users', obj); else await DataManager.addItem('users', obj);
                document.getElementById('modal-container').innerHTML = ''; App.navigate('settings-users');
            }
        };

        const SettingsManagerController = {
            render() { const managers = DataManager.db.managers || []; return `<div class="card"><div class="flex justify-between items-center mb-4"><h3 class="font-bold">Gestoras</h3><button class="btn btn-primary btn-sm" onclick="SettingsManagerController.openModal()"><i class="ph ph-plus"></i> Nova Gestora</button></div><div class="table-container"><table><thead><tr><th>Nome</th><th>Status</th><th>Período Férias</th><th class="text-right">Ações</th></tr></thead><tbody>${managers.map(m => `<tr><td class="font-bold">${m.name}</td><td>${Utils.getStatusBadge(m.status)}</td><td>${m.status === 'Férias' && m.vacationStart ? `${Utils.formatDate(m.vacationStart)} até ${Utils.formatDate(m.vacationEnd)}` : '-'}</td><td class="text-right"><button class="btn btn-outline btn-sm" onclick="SettingsManagerController.openModal(${m.id})"><i class="ph ph-pencil-simple"></i></button><button class="btn btn-danger btn-sm" onclick="if(confirm('Excluir?')) { DataManager.deleteItem('managers', ${m.id}); setTimeout(()=>App.navigate('settings-managers'),200); }"><i class="ph ph-trash"></i></button></td></tr>`).join('')}</tbody></table></div></div>`; },
            openModal(id = null) {
                const manager = id ? DataManager.getManager(id) : null;
                const isEdit = !!manager;
                const isVacation = isEdit && manager.status === 'Férias';
                const displayStyle = isVacation ? 'grid' : 'none';
                const html = `<div class="modal-overlay active"><div class="modal-content"><div class="modal-header"><h3>${isEdit ? 'Editar' : 'Novo'} Gestora</h3><button onclick="document.getElementById('modal-container').innerHTML=''"><i class="ph ph-x"></i></button></div><div class="modal-body"><input type="hidden" id="mgr-id" value="${isEdit ? manager.id : ''}"><div class="form-group"><label class="form-label">Nome</label><input type="text" id="mgr-name" class="form-control" value="${isEdit ? manager.name : ''}"></div><div class="form-group"><label class="form-label">Status</label><select id="mgr-status" class="form-control" onchange="SettingsManagerController.toggleVacationFields(this.value)"><option value="Ativa" ${isEdit && manager.status == 'Ativa' ? 'selected' : ''}>Ativa</option><option value="Desligada" ${isEdit && manager.status == 'Desligada' ? 'selected' : ''}>Desligada</option><option value="Férias" ${isEdit && manager.status == 'Férias' ? 'selected' : ''}>Férias</option></select></div><div id="mgr-vacation-fields" class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem; display: ${displayStyle}; background: #fff9c4; padding: 10px; border-radius: 8px; border: 1px solid #fde047; margin-top: 1rem;"><div class="form-group mb-0"><label class="form-label" style="color: #854d0e;">Início Férias</label><input type="date" id="mgr-vacation-start" class="form-control" value="${isEdit && manager.vacationStart ? manager.vacationStart : ''}"></div><div class="form-group mb-0"><label class="form-label" style="color: #854d0e;">Fim Férias</label><input type="date" id="mgr-vacation-end" class="form-control" value="${isEdit && manager.vacationEnd ? manager.vacationEnd : ''}"></div></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="SettingsManagerController.save()">Salvar</button></div></div></div>`;
                document.getElementById('modal-container').innerHTML = html;
            },
            toggleVacationFields(status) { document.getElementById('mgr-vacation-fields').style.display = status === 'Férias' ? 'grid' : 'none'; },
            async save() {
                const id = document.getElementById('mgr-id').value, name = document.getElementById('mgr-name').value, status = document.getElementById('mgr-status').value, vacationStart = document.getElementById('mgr-vacation-start').value, vacationEnd = document.getElementById('mgr-vacation-end').value;
                if(!name) return alert("Preencha o nome.");
                const obj = { id: id || undefined, name, status, vacationStart: status === 'Férias' ? vacationStart : null, vacationEnd: status === 'Férias' ? vacationEnd : null };
                if(id) await DataManager.updateItem('managers', obj); else await DataManager.addItem('managers', obj);
                document.getElementById('modal-container').innerHTML = ''; App.navigate('settings-managers');
            }
        };

        const SettingsStoreController = {
            render() { const stores = DataManager.db.stores; return `<div class="card"><div class="flex justify-between items-center mb-4"><h3 class="font-bold">Lojas</h3><button class="btn btn-primary btn-sm" onclick="SettingsStoreController.openModal()"><i class="ph ph-plus"></i> Nova Loja</button></div><div class="table-container"><table><thead><tr><th>Nome</th><th>Cidade</th><th>Gestora</th><th class="text-right">Ações</th></tr></thead><tbody>${stores.map(s => { const mgr = s.managerId ? DataManager.getManager(s.managerId) : null; return `<tr><td class="font-bold">${s.name}</td><td>${s.city}</td><td>${mgr ? mgr.name : '-'}</td><td class="text-right"><button class="btn btn-outline btn-sm" onclick="SettingsStoreController.openModal(${s.id})"><i class="ph ph-pencil-simple"></i></button><button class="btn btn-danger btn-sm" onclick="if(confirm('Excluir?')) { DataManager.deleteItem('stores', ${s.id}); setTimeout(()=>App.navigate('settings-stores'),200); }"><i class="ph ph-trash"></i></button></td></tr>`; }).join('')}</tbody></table></div></div>`; },
            openModal(id = null) {
                const store = id ? DataManager.getStore(id) : null;
                const channels = DataManager.db.channels;
                const managers = DataManager.db.managers || [];
                const isEdit = !!store;
                const html = `<div class="modal-overlay active"><div class="modal-content"><div class="modal-header"><h3>${isEdit ? 'Editar' : 'Novo'} Loja</h3><button onclick="document.getElementById('modal-container').innerHTML=''"><i class="ph ph-x"></i></button></div><div class="modal-body"><input type="hidden" id="store-id" value="${isEdit ? store.id : ''}"><div class="form-group"><label class="form-label">Nome</label><input type="text" id="store-name" class="form-control" value="${isEdit ? store.name : ''}" required></div><div class="form-group"><label class="form-label">Código</label><input type="text" id="store-code" class="form-control" value="${isEdit ? store.code : ''}" required></div><div class="form-group"><label class="form-label">Canal</label><select id="store-channel" class="form-control">${channels.map(c => `<option value="${c.id}" ${isEdit && store.channelId == c.id ? 'selected' : ''}>${c.name}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Cidade</label><input type="text" id="store-city" class="form-control" value="${isEdit ? store.city : ''}"></div><div class="form-group"><label class="form-label">Gestora</label><select id="store-manager" class="form-control"><option value="">Selecione...</option>${managers.map(m => `<option value="${m.id}" ${isEdit && store.managerId == m.id ? 'selected' : ''}>${m.name} (${m.status})</option>`).join('')}</select></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="SettingsStoreController.save()">Salvar</button></div></div></div>`;
                document.getElementById('modal-container').innerHTML = html;
            },
            async save() {
                const id = document.getElementById('store-id').value, name = document.getElementById('store-name').value, code = document.getElementById('store-code').value, channelId = document.getElementById('store-channel').value, city = document.getElementById('store-city').value, managerId = document.getElementById('store-manager').value;
                if(!name || !code) return alert("Preencha campos.");
                const obj = { id: id || undefined, name, code, channelId, city, managerId };
                if(id) await DataManager.updateItem('stores', obj); else await DataManager.addItem('stores', obj);
                document.getElementById('modal-container').innerHTML = ''; App.navigate('settings-stores');
            }
        };

        const SettingsChannelController = {
            render() { return `<div class="card"><div class="flex justify-between items-center mb-4"><h3 class="font-bold">Canais</h3><button class="btn btn-primary btn-sm" onclick="SettingsChannelController.openModal()"><i class="ph ph-plus"></i> Nova Canal</button></div><div class="table-container"><table><thead><tr><th>Nome</th><th class="text-right">Ações</th></tr></thead><tbody>${DataManager.db.channels.map(c => `<tr><td class="font-bold">${c.name}</td><td class="text-right"><button class="btn btn-outline btn-sm" onclick="SettingsChannelController.openModal(${c.id})"><i class="ph ph-pencil-simple"></i></button><button class="btn btn-danger btn-sm" onclick="if(confirm('Excluir?')) { DataManager.deleteItem('channels', ${c.id}); setTimeout(()=>App.navigate('settings-channels'),200); }"><i class="ph ph-trash"></i></button></td></tr>`).join('')}</tbody></table></div></div>`; },
            openModal(id=null) {
                const item = id ? DataManager.getChannel(id) : null;
                const isEdit = !!item;
                const html = `<div class="modal-overlay active"><div class="modal-content"><div class="modal-header"><h3>${isEdit ? 'Editar' : 'Novo'} Canal</h3><button onclick="document.getElementById('modal-container').innerHTML=''"><i class="ph ph-x"></i></button></div><div class="modal-body"><input type="hidden" id="ch-id" value="${isEdit ? item.id : ''}"><div class="form-group"><label class="form-label">Nome do Canal</label><input type="text" id="ch-name" class="form-control" value="${isEdit ? item.name : ''}"></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="SettingsChannelController.save()">Salvar</button></div></div></div>`;
                document.getElementById('modal-container').innerHTML = html;
            },
            async save() {
                const id = document.getElementById('ch-id').value, name = document.getElementById('ch-name').value;
                if(!name) return alert("Preencha o nome.");
                const obj = { id: id || undefined, name };
                if(id) await DataManager.updateItem('channels', obj); else await DataManager.addItem('channels', obj);
                document.getElementById('modal-container').innerHTML = ''; App.navigate('settings-channels');
            }
        };

        const SettingsIndicatorController = {
            render() { return `<div class="card"><div class="flex justify-between items-center mb-4"><h3 class="font-bold">Indicadores</h3><button class="btn btn-primary btn-sm" onclick="SettingsIndicatorController.openModal()"><i class="ph ph-plus"></i> Nova Indicador</button></div><div class="table-container"><table><thead><tr><th>Nome</th><th>Canal</th><th class="text-right">Ações</th></tr></thead><tbody>${DataManager.db.indicators.map(i => {const c = DataManager.getChannel(i.channelId); return `<tr><td class="font-bold">${i.name}</td><td>${c?c.name:'N/A'}</td><td class="text-right"><button class="btn btn-outline btn-sm" onclick="SettingsIndicatorController.openModal(${i.id})"><i class="ph ph-pencil-simple"></i></button><button class="btn btn-danger btn-sm" onclick="if(confirm('Excluir?')) { DataManager.deleteItem('indicators', ${i.id}); setTimeout(()=>App.navigate('settings-indicators'),200); }"><i class="ph ph-trash"></i></button></td></tr>`;}).join('')}</tbody></table></div></div>`; },
            openModal(id=null) {
                const item = id ? DataManager.db.indicators.find(i=>i.id==id) : null;
                const isEdit = !!item;
                const html = `<div class="modal-overlay active"><div class="modal-content"><div class="modal-header"><h3>${isEdit ? 'Editar' : 'Novo'} Indicador</h3><button onclick="document.getElementById('modal-container').innerHTML=''"><i class="ph ph-x"></i></button></div><div class="modal-body"><input type="hidden" id="ind-id" value="${isEdit ? item.id : ''}"><div class="form-group"><label class="form-label">Nome</label><input type="text" id="ind-name" class="form-control" value="${isEdit ? item.name : ''}"></div><div class="form-group"><label class="form-label">Canal</label><select id="ind-channel" class="form-control">${DataManager.db.channels.map(c => `<option value="${c.id}" ${isEdit && item.channelId == c.id ? 'selected' : ''}>${c.name}</option>`).join('')}</select></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="SettingsIndicatorController.save()">Salvar</button></div></div></div>`;
                document.getElementById('modal-container').innerHTML = html;
            },
            async save() {
                const id = document.getElementById('ind-id').value, name = document.getElementById('ind-name').value, channelId = document.getElementById('ind-channel').value;
                if(!name || !channelId) return alert("Preencha campos.");
                const obj = { id: id || undefined, name, channelId, weight: 0 };
                if(id) await DataManager.updateItem('indicators', obj); else await DataManager.addItem('indicators', obj);
                document.getElementById('modal-container').innerHTML = ''; App.navigate('settings-indicators');
            }
        };

        const SettingsQuestionController = {
            filterChannelId: 'all',

            render() { 
                const questions = DataManager.db.questions;
                const channels = DataManager.db.channels;
                
                let filteredQuestions = questions;
                if (this.filterChannelId !== 'all') {
                    // Atualizado: Tenta filtrar direto pela coluna channelId (mais rápido), 
                    // com fallback para a lógica antiga (via indicador) caso o dado em memória ainda não tenha o ID.
                    filteredQuestions = questions.filter(q => {
                        if (q.channelId) return q.channelId == this.filterChannelId;
                        // Fallback
                        const ind = DataManager.db.indicators.find(i => i.id == q.indicatorId);
                        return ind && ind.channelId == this.filterChannelId;
                    });
                }

                return `
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold">Perguntas</h3>
                            <button class="btn btn-primary btn-sm" onclick="SettingsQuestionController.openModal()"><i class="ph ph-plus"></i> Nova Pergunta</button>
                        </div>
                        
                        <div class="flex gap-4 items-end mb-4" style="background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                            <div class="form-group mb-0" style="flex:1; max-width: 300px;">
                                <label class="form-label">Filtrar por Canal</label>
                                <select class="form-control" onchange="SettingsQuestionController.setFilter(this.value)">
                                    <option value="all">Todos</option>
                                    ${channels.map(c => `<option value="${c.id}" ${this.filterChannelId == c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="table-container">
                            <table>
                                <thead><tr><th>Texto</th><th>Indicador</th><th>Gravidade</th><th class="text-right">Ações</th></tr></thead>
                                <tbody>
                                    ${filteredQuestions.map(q => {
                                        const ind = DataManager.db.indicators.find(i => i.id == q.indicatorId);
                                        return `<tr>
                                            <td class="font-bold">${q.text}</td>
                                            <td class="text-muted">${ind ? ind.name : '-'}</td>
                                            <td>${Utils.getSeverityBadge(q.severity)}</td>
                                            <td class="text-right">
                                                <button class="btn btn-outline btn-sm" onclick="SettingsQuestionController.openModal(${q.id})"><i class="ph ph-pencil-simple"></i></button>
                                                <button class="btn btn-danger btn-sm" onclick="if(confirm('Excluir?')) { DataManager.deleteItem('questions', ${q.id}); setTimeout(()=>App.navigate('settings-questions'),200); }"><i class="ph ph-trash"></i></button>
                                            </td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`; 
            },

            setFilter(val) {
                this.filterChannelId = val;
                document.getElementById('content').innerHTML = this.render();
            },

            openModal(id=null) {
                const item = id ? DataManager.getQuestion(id) : null;
                const isEdit = !!item;
                
                let initialChannelId = "";
                if (item) {
                    // Atualizado: Usa o channelId direto se existir, senão procura pelo indicador
                    initialChannelId = item.channelId;
                    if (!initialChannelId) {
                        const ind = DataManager.db.indicators.find(i => i.id == item.indicatorId);
                        if (ind) initialChannelId = ind.channelId;
                    }
                }

                const channels = DataManager.db.channels;

                const html = `
                    <div class="modal-overlay active">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>${isEdit ? 'Editar' : 'Nova'} Pergunta</h3>
                                <button onclick="document.getElementById('modal-container').innerHTML=''"><i class="ph ph-x"></i></button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" id="q-id" value="${isEdit ? item.id : ''}">
                                
                                <div class="form-group">
                                    <label class="form-label">Canal</label>
                                    <select id="q-channel" class="form-control" onchange="SettingsQuestionController.updateModalIndicators(this.value)">
                                        <option value="">Selecione...</option>
                                        ${channels.map(c => `<option value="${c.id}" ${initialChannelId == c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Indicador</label>
                                    <select id="q-ind" class="form-control">
                                        <option value="">Selecione um Canal acima...</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Texto</label>
                                    <textarea id="q-text" class="form-control">${isEdit ? item.text : ''}</textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Gravidade</label>
                                    <select id="q-sev" class="form-control">
                                        <option value="leve" ${isEdit && item.severity == 'leve' ? 'selected' : ''}>Leve (-1)</option>
                                        <option value="media" ${isEdit && item.severity == 'media' ? 'selected' : ''}>Média (-2.5)</option>
                                        <option value="grave" ${isEdit && item.severity == 'grave' ? 'selected' : ''}>Grave (-4)</option>
                                        <option value="gravissima" ${isEdit && item.severity == 'gravissima' ? 'selected' : ''}>Gravíssima (-50)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-primary" onclick="SettingsQuestionController.save()">Salvar</button>
                            </div>
                        </div>
                    </div>`;
                document.getElementById('modal-container').innerHTML = html;
                this.updateModalIndicators(initialChannelId, item ? item.indicatorId : null);
            },

            updateModalIndicators(channelId, selectedIndId = null) {
                const indSelect = document.getElementById('q-ind');
                if (!channelId) {
                    indSelect.innerHTML = '<option value="">Selecione um Canal acima...</option>';
                    return;
                }
                const indicators = DataManager.db.indicators.filter(i => i.channelId == channelId);
                if (indicators.length === 0) {
                    indSelect.innerHTML = '<option value="">Sem indicadores neste canal</option>';
                } else {
                    indSelect.innerHTML = indicators.map(i => `<option value="${i.id}" ${selectedIndId == i.id ? 'selected' : ''}>${i.name}</option>`).join('');
                }
            },

            async save() {
                const id = document.getElementById('q-id').value;
                const text = document.getElementById('q-text').value;
                const indicatorId = document.getElementById('q-ind').value;
                const severity = document.getElementById('q-sev').value;
                const channelId = document.getElementById('q-channel').value; // Novo: Captura o valor do Canal
                
                if(!text || !indicatorId || !channelId) return alert("Preencha todos os campos.");
                
                // Novo: Inclui channelId no objeto a salvar
                const obj = { id: id || undefined, text, indicatorId, severity, channelId };
                if(id) await DataManager.updateItem('questions', obj); else await DataManager.addItem('questions', obj);
                document.getElementById('modal-container').innerHTML = ''; App.navigate('settings-questions');
            }
        };

        function toggleSidebarDesktop() {
            const sidebar = document.getElementById('main-sidebar');
            const mainContent = document.getElementById('main-content');
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }
        function toggleSidebar() { document.querySelector('.sidebar').classList.toggle('open'); }
        
        window.onload = () => App.init();
    </script>
</body>
</html>
